// NOTE: This passage is easier to read in NotePad
// because certain lines are extremely long

// JsonObject that lists all rules
// it is required that all function look like
// function name(){...}
// if there are comments that belong to the function
// please locate them inside of the function

RuleList = {Rules:[
/*
	{
	rule_id:"header_1",
	wcag_code:"2.4.2",
	sect508_code:"22.d",
	param:tags,
	pass_message:"there are 1 or 2 h1 tags that are not empty, however make sure content of h1 tags are descriptive headings",
	fail_message:"h1 tags do not exist or there are more than 2 h1 tags or there exist empty h1 tags",
	title:"Missing or empty H1 tag.",
	validate:
		function (tags)
		{
			// checks to see that there are at most 2 h1 tags
			// and at least 1 h1 tag
			// all h1 tags must not be empty
			function h1TagRuleCheckOneOrTwoAndNotEmpty(tags)
			{
				var h1Nodes = getElementsByTagName(tags,"h1");
				var emptyH1Nodes = [];
				for(var i = 0; i < h1Nodes.length; i++)
				{
					var h1Node = h1Nodes[i];
					if(getNodeTextRecursively(h1Node).length == 0)
					{
						emptyH1Nodes.push(h1Node);
					} // end if
				} // end for

				var passed = (h1Nodes.length == 1 || h1Nodes.length == 2) && emptyH1Nodes.length == 0;

				var pass_fail = new Object();
				if(passed)
				{
					pass_fail.passed = "true";
					pass_fail.message = "there are 1 or 2 h1 tags that are not empty, however make sure content of h1 tags are descriptive headings";
				}
				else
				{
					pass_fail.passed = "false";
					pass_fail.message = "h1 tags do not exist or there are more than 2 h1 tags or there exist empty h1 tags";
				}

				return pass_fail;
			}

			// variable local to function to store all the results
			var result = new Object();
			result.rule_id = "header_1";
			result.wcag_code = "2.4.2";
			result.sect508_code = "22.d";
			result.test_results = new Array();

			// function call to begin rule validation
			result.test_results.push(h1TagRuleCheckOneOrTwoAndNotEmpty(tags));

			return result;
		}
	},*/
	{
	rule_id:"header_2",
	wcag_code:"2.4.6",
	sect508_code:"",
	param:tags,
	pass_message:"Headers are properly nested.",
	fail_message:"Headers are not properly nested.",
	title:"Headers must be properly nested",
	validate:
		function(tags)
		{
			var headerList = ["h1","h2","h3","h4","h5","h6"];
			function checkNestedHeaders(tags)
			{
				var result = true;
				for(var i = 0; i < tags.length; i++)
				{
					result = result && checkNestedHeadersHelper(tags[i],0);
				}
				return result;
			}
			function checkNestedHeadersHelper(tags, level)
			{
				var headerLevel = level;
				if(tags.tagName != null)
				{
					if(contains(headerList, tags.tagName))
					{
						headerLevel = parseInt(tags.tagName.substring(tags.tagName.length-1));
						
						if(headerLevel < level)
							return false;
					}
				}
				
				if(tags.content != null)
				{
					for(var i = 0; i < tags.content.length; i++)
					{
						return checkNestedHeadersHelper(tags.content[i], headerLevel)
					}
				}
				
				return true;
			}
			
			// variable local to function to store all the results
			var result = new Object();
			result.rule_id = "header_2";
			result.wcag_code = "2.4.6";
			result.sect508_code = "";
			result.test_results = new Array();
			
			// function call to begin rule validation
			var pass_fail = new Object();
			var passed = checkNestedHeaders(tags);
			if(passed)
			{
				pass_fail.passed = "true";
				pass_fail.message = "Headers are properly nested.";
			}
			else
			{
				pass_fail.passed = "false";
				pass_fail.message = "Headers are not properly nested.";
			}
			
			result.test_results.push(pass_fail);
			
			return result;
		}
	},
	{
	rule_id:"title_1",
	wcag_code:"2.4.2",
	sect508_code:"22.i",
	param:title,
	pass_message:"title tag is not empty, make sure it accurately describes the document",
	fail_message:"title tag is empty",
	title:"Title tag should not be empty.",
	validate:
		function(title)
		{
			// checks to see that the title tag is not empty
			function titleRuleCheckNonEmpty(title)
			{
				var pass_fail = new Object();
				if(title[0].text == null || title[0].text.equals(""))
				{
					pass_fail.passed = false;
					pass_fail.message = "title tag is empty";
				}
				else
				{
					pass_fail.passed = "true";
					pass_fail.message = "title tag is not empty, make sure it accurately describes the document";
				}
				
				return pass_fail;
			}
			
			
			// variable local to function to store all the results
			var result = new Object();
			result.rule_id = "title_1";
			result.wcag_code = "2.4.2";
			result.sect508_code = "22.i";
			result.test_results = new Array();

			// function call to begin rule validation
			result.test_results.push(titleRuleCheckNonEmpty(title));

			return result;
		}
	},
	{
	rule_id:"author_1",
	wcag_code:"2.4.2",
	sect508_code:"22.i",
	param:author,
	pass_message:"author tag is not empty, make sure it accurately describes the author of the document",
	fail_message:"author tag is empty",
	title:"Author tag should not be empty.",
	validate:
		function(author)
		{
			// checks to see that the author tag is not empty
			function titleRuleCheckNonEmpty(author)
			{
				var pass_fail = new Object();
				if(author[0].text == null || author[0].text.equals(""))
				{
					pass_fail.passed = false;
					pass_fail.message = "author tag is empty";
				}
				else
				{
					pass_fail.passed = "true";
					pass_fail.message = "author tag is not empty, make sure it accurately describes the document";
				}
				
				return pass_fail;
			}
			
			
			// variable local to function to store all the results
			var result = new Object();
			result.rule_id = "author_1";
			result.wcag_code = "2.4.2";
			result.sect508_code = "22.i";
			result.test_results = new Array();

			// function call to begin rule validation
			result.test_results.push(titleRuleCheckNonEmpty(title));

			return result;
		}
	},
	{
	rule_id:"creator_1",
	wcag_code:"2.4.2",
	sect508_code:"22.i",
	param:creator,
	pass_message:"creator tag is not empty, make sure it accurately describes the author of the document",
	fail_message:"creator tag is empty",
	title:"creator tag should not be empty.",
	validate:
		function(creator)
		{
			// checks to see that the creator tag is not empty
			function titleRuleCheckNonEmpty(creator)
			{
				var pass_fail = new Object();
				if(creator[0].text == null || creator[0].text.equals(""))
				{
					pass_fail.passed = false;
					pass_fail.message = "creator tag is empty";
				}
				else
				{
					pass_fail.passed = "true";
					pass_fail.message = "creator tag is not empty, make sure it accurately describes the document";
				}
				
				return pass_fail;
			}
			
			
			// variable local to function to store all the results
			var result = new Object();
			result.rule_id = "creator_1";
			result.wcag_code = "2.4.2";
			result.sect508_code = "22.i";
			result.test_results = new Array();

			// function call to begin rule validation
			result.test_results.push(titleRuleCheckNonEmpty(title));

			return result;
		}
	}
]};

// all the code after this is required to call all validations
// in the rules list and then push the output onto a results
// list

// setup the results list
var resultsList = new Array();

// populate the results list
for(var rulesIndex = 0; rulesIndex < RuleList.Rules.length; rulesIndex++)
{
	// call the rule and store in rule result
	var ruleResult = RuleList.Rules[rulesIndex].validate(RuleList.Rules[rulesIndex].param);
	resultsList.push(ruleResult);
}

// important pdf tags
// 	sections: sect
// 	headings: h1-h6
// 	paragraphs: p
// 	captions: caption
// 	tables: table
// 	figures/images: figure
// 	lists: L
// 	forms: form
// 	bookmarks: Bookmark

// initialize search array
var importantTags = new Array();
importantTags.push("sect");
importantTags.push("h1");
importantTags.push("h2");
importantTags.push("h3");
importantTags.push("h4");
importantTags.push("h5");
importantTags.push("h6");
importantTags.push("p");
importantTags.push("caption");
importantTags.push("table");
importantTags.push("figure");
importantTags.push("l");
importantTags.push("form");
importantTags.push("bookmark");

// initialize count array
var importantTagsCount = new Object();
importantTagsCount.sect = 0;
importantTagsCount.h1 = 0;
importantTagsCount.h2 = 0;
importantTagsCount.h3 = 0;
importantTagsCount.h4 = 0;
importantTagsCount.h5 = 0;
importantTagsCount.h6 = 0;
importantTagsCount.p = 0;
importantTagsCount.caption = 0;
importantTagsCount.table = 0;
importantTagsCount.figure = 0;
importantTagsCount.l = 0;
importantTagsCount.form = 0;
importantTagsCount.bookmark = 0;
importantTagsCountLength = 14;

countImportantTags(root);

// write results object to file
print("{\n");

// write results of tag counting to file (inside of results object)
print("	\"TagCount\":{\n");
for(item in importantTagsCount)
{
	print("		\"" + item + "\": \"" + importantTagsCount[item] + "\"");
	importantTagsCountLength--;
	if(importantTagsCountLength != 0)
		print(",\n");
	else
		print("\n");
}
print("	},\n");

// write results of rules to file (inside of results object)
print("	\"Results\":[\n");
for(var i = 0; i < resultsList.length; i++)
{
	print("		{\n");
	print("		\"rule_id\":\"" + resultsList[i].rule_id + "\",\n");
	print("		\"test_results\":[\n");

	var rule_results = resultsList[i].test_results;
	
	for(var j = 0; j < rule_results.length; j++)
	{
		print("			{\n");
		print("			\"passed\":\"" + rule_results[j].passed + "\",\n");
		print("			\"message\":\"" + rule_results[j].message + "\"\n");
		print("			}");
		if(j != rule_results.length - 1)
			print(",\n");
		else
			print("\n");
	}
	print("		],\n");
	print("		\"wcag_code\":\"" + resultsList[i].wcag_code + "\",\n");
	print("		\"sect508_code\":\"" + resultsList[i].sect508_code + "\"\n");
	print("		}");
	if(i != resultsList.length - 1)
		print(",\n");
	else
		print("\n");
}
print("	]\n");
print("}");